<html>
<head>
<title>Password Bolt - User Manual</title>
<link href="style/main.css" rel="stylesheet" type="text/css">
</head>

<body>
<h1>Password Bolt - User Manual and Technical Details</h1>
<h2>3. Adding a password</h2>
<h3>3.1 Basic Operation</h3>
Once logged in to your account you can add passwords which will be encrypted and protected by Password Bolt. To add a password, find the 'New Password' section on the 'My Passwords' page. Enter the information you want to save in the database. 'Name' is the name of the password so you can recognize it in the list. 'Link URL' is an optional URL you can enter so you can quickly navigate to a web page when viewing a password. 'Username' is the optional username tied to that password, for example the username to login to a website. 'Password' is the password you want to save. 'Confirm Password' should be the same as 'Password', we ask for it twice to avoid typos.
<br /><br />
Optionally, you can encrypt your password with a second level of encryption. This encryption runs in the web browser, so it is encrypted before it is sent to the server. To use In-Browser encryption, enter the password you want to use for encryption. You will be asked for this password every time you view a password encrypted with In-Browser encryption. After you have entered and confirmed the password, click 'Encrypt'. Your browser will encrypt the password and should say 'Your password has been encrypted with in-browser encryption'. You may now add the password to the database.
<h3>3.2 Technical Details</h3>
<h4>3.2.1 Authenticating the Ciphertext</h4>
Even though there is no authentication between the user and the account username, there is authentication between the user and the ciphertexts of his encrypted passwords. A hash token is created of the user's encryption key for each entry in the database. This ensures that without the correct key, an attacker can not access the ciphertexts. To provide an excuse for other rows being present in the database when the user is forced to reveal his password, a random password may be added to the database everytime the user adds a password (1/3 probability).<br /><br />

Before querying the database, PHP code hashes the authentication token and key togeather:<br />
token = ServerHash(token + key)<br />
Remember that the original authentication token is not really needed, it is kept in the code to make it easier to convert back to normal authentication if it is required.<br />
Now, the database is queried, and the final token is created on the fly with MySQL's built in SHA1 function:<br />
SELECT ... WHERE token=SHA1(concat(SHA1(concat('$token',salt)) , '$token'))<br />
the database column `salt` contains salt that is unique to every row<br /><br />

The effect of this is that it is impossible to prove that a row belongs to a user without their private key.
<h4>3.2.2 Encrypting the passwords</h4>
Encryption is fairly simple, everything is encrypted with the key created with the UserKey function as described in the login section.<br /><br />
First, two 256 bit keys are created from the user's 768 key:<br />
tfkey = first 256 bits of key<br />
aeskey = second 256 bits of key<br /><br />

Then a random 256 bit IV is generated:<br />
iv = get256()<br /><br />

Then the data is encrypted:<br />
- First with AES in CBC mode, using aeskey<br />
- Then the ciphertext is encrypted again with TWOFISH in ECB mode, using tfkey<br /><br />

Then a hash is created of the ciphertext to verify that it isn't modified, and prepended to the ciphertext:<br />
final = ServerHash(ciphertext + last 256 bits of key) + ciphertext<br />
Decryption is simply checking that the hash of the ciphertext matches what it is supposed to be, and decrypting it with the reverse operation.
<h4>3.2.3 In-Browser encryption</h4>

When the user encrypts a password with the javascript encryption, javascript uses random salt provided by the website to create a 448 bit key. 
The key is generated with multiple SHA256 hashes. Another key is created in the same way for authenticating the ciphertext. 
The password is then encrypted with BLOWFISH in CBC mode. <s>The IV is provided by javascript's built in random number function then run through through the blowfish encryption function to strengthen the randomness.</s> (If you read that, you must be screaming BAD CRYPTO!). The IV is provided by javascript's weak PRNG, but unique salt (from the CSPRNG) is used to create the encryption key for every password encrypted with JavaScript. So the chances of an IV and key pair occuring more than once is effectively zero.
<br /><br />
When the user wants to decrypt the password, the website provides the same salt, javascript generates the same keys, checks the authenticity of the ciphertext, then decrypts it. 
<br />


<div class="cwrap">
<div id="navbar">
<table border=1>
<tr><td><a href="index.html">0. Introduction</a></td><td><a href="deletepw.html">6. Deleting a password</a></td></tr>
<tr><td><a href="create.html">1. Creating an account</a></td><td><a href="rng.html">7. Random password generator</a></td></tr>
<tr><td><a href="login.html">2. Logging in</a></td><td><a href="notepad.html">8. Using the notepad</a></td></tr>
<tr><td><a href="addpw.html">3. Adding a password</a></td><td><a href="logout.html">9. Logging out</a></td></tr>
<tr><td><a href="viewpw.html">4. Viewing a password</a></td><td><a href="changeacct.html">10. Changing the account password</a></td></tr>
<tr><td><a href="changepw.html">5. Changing a password</a></td><td><a href="deleteacct.html">11. Deleting the account</a></td></tr>
<tr><td></td><td><a href="sfunc.html">Cryptographic functions</a></td></tr>
</table>
</div>
</div>


</body>
</html>
